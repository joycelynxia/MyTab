generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String      @id @default(uuid())
  email        String      @unique
  passwordHash String
  name         String
  createdAt    DateTime    @default(now())
  groupUsers   GroupUser[]
}

model GroupUser {
  id        String   @id @default(uuid())
  userId    String
  groupId   String
  role      String   // "admin" | "participant" | "viewer"
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
}

model Group {
  id               String       @id @default(uuid())
  groupName        String
  shareToken       String       @unique
  createdAt        DateTime     @default(now())
  creatorMemberId  String?      // guest who created the group; used for admin on link
  groupUsers       GroupUser[]
  members          Member[]
  expenses         Expense[]
  settlements      Settlement[]
  receipts         Receipt[]
}

model Receipt {
  id        String    @id @default(uuid())
  groupId   String
  group     Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  imageData String?   // base64 for display
  createdAt DateTime  @default(now())
  expenses  Expense[]
}

model Member {
  id         String @id @default(uuid())
  groupId    String
  group      Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  memberName String
  balance    Float  @default(0)

  // Expenses this member has paid
  expensesPaid Expense[] @relation("Payer")

  // Splits (expenses this member participates in)
  splits Split[]

  // Settlements
  settlementsPaid     Settlement[] @relation("SettlementsPaid")
  settlementsReceived Settlement[] @relation("SettlementsReceived")
}

model Expense {
  id          String   @id @default(uuid())
  groupId     String
  group       Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  expenseName String
  amount      Float
  date        DateTime @default(now())
  payerId     String
  payer       Member   @relation("Payer", fields: [payerId], references: [id])
  addedById   String?
  imageData      String[]   @default([])
  
  receiptId   String?
  receipt     Receipt? @relation(fields: [receiptId], references: [id], onDelete: SetNull)

  splits Split[]
}

model Split {
  id        String  @id @default(uuid())
  expenseId String
  expense   Expense @relation(fields: [expenseId], references: [id])
  memberId  String
  memberName String
  member    Member  @relation(fields: [memberId], references: [id])
  amount    Float
  percent   Float
}

model Settlement {
  id      String   @id @default(uuid())
  groupId String
  group   Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  amount  Float
  date    DateTime @default(now())
  note    String?

  payerId String
  payer   Member @relation("SettlementsPaid", fields: [payerId], references: [id])

  payeeId String
  payee   Member @relation("SettlementsReceived", fields: [payeeId], references: [id])
}
